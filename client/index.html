<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>Project Managment</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
</head>
<body onload="main()">
  <section class="hero is-light is-fullheight">
    <div class="hero-body">
      <div class="container" id="login">
        <div class="columns is-vcentered">
          <div class="column is-4 is-offset-4">
            <div class="container">
              <div class="box">
                <form id="loginForm">
                  <div class="field">
                    <div class="control">
                      <label class="label">Email</label>
                      <div class="control">
                        <input class="input" type="Email" id="email" name="email" placeholder="Email" />
                      </div>
                    </div>
                  </div>
                  <div class="field">
                    <div class="control">
                      <label class="label">Contraseña</label>
                      <div class="control">
                        <input class="input" type="Password" id="pass" name="pass" placeholder="Contraseña" />
                      </div>
                    </div>
                  </div>
                  <div class="field">
                    <div class="control">
                      <button class="button is-primary is-fullwidth" type="submit">
                        Ingresar
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="container" id="projectBoard"></div>
      <div class="container" id="deliveryBoard"></div>
    </div>
  </section>
  <script>
    //Referencias
    // https://medium.com/walmartglobaltech/writing-a-graphql-client-in-vanilla-js-d2a09aee7c6c
    // https://gist.github.com/yusinto/30bba51b6f903c1b67e0383f4a288269
    // https://www.youtube.com/watch?v=V1Zz2fUuaXI

    const graphlEndpoint = `https://vukapi.herokuapp.com/`;
    
    const formLogin = document.querySelector("#loginForm");
    const projectBoard = document.querySelector("#projectBoard");
    const deliveryBoard = document.querySelector("#deliveryBoard");

    function main() {
      document.getElementById("projectBoard").style.display = "none";
      document.getElementById("deliveryBoard").style.display = "none";
    }

    async function renderProjects(user) {
      let projects = await readProjects(user.id);
      console.log(projects);
      const first = '<div class="columns"><div class="column is-6 is-offset-3"><div class="box"><p>Agregar proyecto</p></div>';
      let middle = "";
      const last = '</div></div>';
      console.log(projects.length)
      for(i=0; i<projects.length; i++){
        middle += '<div class="container pb-2" onclick="renderDeliverys('+projects[i].id+')"><div class="box"><strong>'+projects[i].titulo+'</strong><p>'+projects[i].descripcion+'</p><div class="buttons py-3"><button class="button is-small is-primary">Editar</button><button class="button is-small is-primary">Eliminar</button></div></div></div>';
      }
      let code = first + middle + last
      document.getElementById("login").style.display = "none";
      document.getElementById("projectBoard").style.display = "inline";
      document.getElementById('projectBoard').innerHTML = code;
    }

    async function renderDeliverys(project) {
      let deliverys = await readDelivery(project);
      const first = '<div class="columns"><div class="column is-6 is-offset-3"><div class="box"><p>Agregar entrega</p></div>';
      let middle = "";
      const last = '</div></div>';
      console.log(deliverys.length)
      for(i=0; i<deliverys.length; i++){
        middle += '<div class="container pb-2"><div class="box"><strong>No. Entrega: '+deliverys[i].numEntrega+'</strong><p>'+deliverys[i].descripcion+'</p><div class="buttons py-3"><button class="button is-small is-primary">Editar</button><button class="button is-small is-primary">Eliminar</button></div></div></div>';
      }
      let code = first + middle + last
      document.getElementById("login").style.display = "none";
      document.getElementById("projectBoard").style.display = "none";
      document.getElementById("deliveryBoard").style.display = "inline";
      document.getElementById('deliveryBoard').innerHTML = code;
    }

    async function readProjects(userID){
      const query = JSON.stringify({
        query: `query{
          ProyectosUsuario(idUsuario:${userID}){
            id,
            titulo,
            descripcion,
          }
        }`
      });
      const response = await fetch(graphlEndpoint, {
        headers: { 'content-type': 'application/json' },
        method: 'POST',
        body: query,
      });
      const responseJson = await response.json();
      let data = responseJson.data.ProyectosUsuario;
      console.log(responseJson);
      return(data);
    }

    async function readDelivery(projectID){
      const query = JSON.stringify({
        query: `query{
          EntregasDeProyecto(idProyecto:${projectID}){
            numEntrega,
            descripcion
          }
        }`
      });
      const response = await fetch(graphlEndpoint, {
        headers: { 'content-type': 'application/json' },
        method: 'POST',
        body: query,
      });
      const responseJson = await response.json();
      let data = responseJson.data.EntregasDeProyecto;
      console.log(responseJson);
      return(data);
    }

    const login = async (ev) => {
      ev.preventDefault();
      const email = formLogin.elements["email"].value;
      const pass = formLogin.elements["pass"].value;
      const query = JSON.stringify({
        query: `query{
          Login(email:"${email}", password:"${pass}"){
            id
          }
        }`
      });
      const response = await fetch(graphlEndpoint, {
        headers: { 'content-type': 'application/json' },
        method: 'POST',
        body: query,
      });
      const responseJson = await response.json();
      let data = responseJson.data.Login;
      renderProjects(data);
      //form.reset();
    }

    formLogin.addEventListener("submit", login);
  </script>
  <!--<script src="script.js"></script>-->
</body>

</html>